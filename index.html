<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DTU Course Sniper - Săn Slot Tín Chỉ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, onValue, push, set, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // --- CẤU HÌNH ---
        const firebaseConfig = {
            apiKey: "AIzaSyAjgMEBvwLopIA0smZXY8zpWL3uxiLjQtE",
            authDomain: "tool-theo-doi-slot.firebaseapp.com",
            projectId: "tool-theo-doi-slot",
            storageBucket: "tool-theo-doi-slot.firebasestorage.app",
            messagingSenderId: "84464301578",
            appId: "1:84464301578:web:3ea64e467eca65e847d1f3",
            databaseURL: "https://tool-theo-doi-slot-default-rtdb.asia-southeast1.firebasedatabase.app"
        };

        let db;

        function initApp() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getDatabase(app);
                console.log("Firebase connected!");
                listenToClasses();
            } catch (e) {
                console.error("Firebase Error:", e);
                alert("Lỗi kết nối Database.");
            }
        }

        function listenToClasses() {
            const classesRef = ref(db, 'mon_hoc');
            onValue(classesRef, (snapshot) => {
                const container = document.getElementById('class-grid');
                container.innerHTML = '';
                const data = snapshot.val();
                updateStats(data);

                if (!data) {
                    document.getElementById('empty-state').classList.remove('hidden');
                    return;
                }
                document.getElementById('empty-state').classList.add('hidden');
                
                Object.keys(data).forEach(key => {
                    if (typeof data[key] === 'object') createClassCard(key, data[key]);
                });
            });
        }

        function updateStats(data) {
            if (!data) {
                document.getElementById('stat-total').innerText = '0';
                document.getElementById('stat-available').innerText = '0';
                return;
            }
            const validItems = Object.values(data).filter(item => typeof item === 'object');
            document.getElementById('stat-total').innerText = validItems.length;
            document.getElementById('stat-available').innerText = validItems.filter(item => parseInt(item.slots) > 0).length;
            
            const dates = validItems.map(item => item.last_check).filter(d => d);
            if (dates.length > 0) document.getElementById('stat-last-check').innerText = dates[0].split(' ')[1] || 'Vừa xong'; 
        }

        function createClassCard(id, data) {
            const container = document.getElementById('class-grid');
            const slots = parseInt(data.slots);
            const isAvailable = slots > 0;
            const isError = data.slots === "Lỗi" || data.slots === "Unknown" || data.slots === "?";
            
            let statusColor = isAvailable ? 'bg-green-100 text-green-800 border-green-200' : 'bg-red-100 text-red-800 border-red-200';
            let icon = isAvailable ? '<i class="fa-solid fa-check-circle"></i>' : '<i class="fa-solid fa-times-circle"></i>';
            let statusText = isAvailable ? 'Còn Slot' : 'Hết Chỗ';
            let slotsDisplay = data.slots;
            
            if (isError) {
                statusColor = 'bg-yellow-100 text-yellow-800 border-yellow-200';
                icon = '<i class="fa-solid fa-exclamation-triangle"></i>';
                statusText = 'Chờ/Lỗi';
                slotsDisplay = '?';
            }

            // Xử lý mã đăng ký
            const regCode = data.registration_code || "...";

            const card = document.createElement('div');
            card.className = `bg-white rounded-xl shadow-sm border border-slate-200 hover:shadow-md transition-all duration-200 overflow-hidden relative group`;
            
            card.innerHTML = `
                <div class="p-5">
                    <div class="flex justify-between items-start mb-4">
                        <div class="w-full pr-2">
                            <div class="flex items-center gap-2 mb-2">
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-50 text-blue-700 border border-blue-100">
                                    ${data.code || '...'}
                                </span>
                                <!-- Badge Mã Đăng Ký (Có nút Copy) -->
                                <div class="flex items-center bg-gray-50 border border-gray-200 rounded-md px-2 py-0.5 max-w-full overflow-hidden" title="Mã đăng ký: ${regCode}">
                                    <span class="text-xs font-mono text-gray-600 truncate mr-1 select-all">${regCode}</span>
                                    ${regCode !== '...' ? `
                                    <button onclick="copyToClipboard('${regCode}')" class="text-gray-400 hover:text-blue-600 transition-colors p-0.5">
                                        <i class="fa-regular fa-copy text-xs"></i>
                                    </button>` : ''}
                                </div>
                            </div>
                            <h3 class="text-lg font-bold text-slate-800 leading-tight line-clamp-2 h-12" title="${data.name}">
                                ${data.name || 'Đang lấy thông tin...'}
                            </h3>
                        </div>
                        <div class="flex-shrink-0">
                            <span class="relative flex h-3 w-3">
                                ${isAvailable ? '<span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>' : ''}
                                <span class="relative inline-flex rounded-full h-3 w-3 ${isAvailable ? 'bg-green-500' : (isError ? 'bg-yellow-500' : 'bg-red-500')}"></span>
                            </span>
                        </div>
                    </div>
                    
                    <div class="flex items-center justify-between mt-4">
                        <div class="flex flex-col">
                            <span class="text-xs text-slate-500 uppercase font-semibold tracking-wider">Số chỗ trống</span>
                            <span class="text-3xl font-extrabold ${isAvailable ? 'text-green-600' : (isError ? 'text-yellow-600' : 'text-red-500')}">
                                ${slotsDisplay}
                            </span>
                        </div>
                        <div class="text-right">
                             <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium border ${statusColor}">
                                ${icon} <span class="ml-1.5">${statusText}</span>
                            </span>
                        </div>
                    </div>

                    <div class="mt-4 pt-4 border-t border-slate-100 flex items-center justify-between text-xs text-slate-500">
                        <span><i class="fa-regular fa-clock mr-1"></i> ${data.last_check || 'Chưa chạy'}</span>
                        <div class="flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                            <a href="${data.url}" target="_blank" class="text-blue-600 hover:text-blue-800 font-medium hover:underline">
                                Đăng ký
                            </a>
                            <button onclick="window.deleteClass('${id}')" class="text-red-400 hover:text-red-600 ml-2">
                                <i class="fa-solid fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `;
            container.appendChild(card);
        }

        window.handleAddClass = (e) => {
            e.preventDefault();
            const urlInput = document.getElementById('class-url');
            const url = urlInput.value.trim();
            if (!url || !url.includes('classid=')) return alert("Link không hợp lệ!");

            const newClassRef = push(ref(db, 'mon_hoc'));
            set(newClassRef, { 
                url: url, name: "Đang chờ check...", code: "...", slots: "?", registration_code: "...",
                last_check: "Chờ worker...", created_at: Date.now() 
            }).then(() => { urlInput.value = ''; });
        };

        window.deleteClass = (id) => {
            if(confirm("Xóa lớp này?")) remove(ref(db, 'mon_hoc/' + id));
        };

        // Hàm Copy vào Clipboard
        window.copyToClipboard = (text) => {
            navigator.clipboard.writeText(text).then(() => {
                // Có thể thêm toast notification ở đây nếu muốn
                alert("Đã copy mã: " + text); 
            }).catch(err => {
                console.error('Không copy được: ', err);
            });
        };

        initApp();
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        ::-webkit-scrollbar { width: 8px; }
    </style>
</head>
<body class="text-slate-600">
    <header class="bg-white border-b border-slate-200 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-indigo-600 rounded-lg flex items-center justify-center text-white shadow-lg shadow-indigo-200">
                        <i class="fa-solid fa-crosshairs text-xl"></i>
                    </div>
                    <div>
                        <h1 class="text-xl font-bold text-slate-800 tracking-tight">DTU Course Sniper</h1>
                        <p class="text-xs text-slate-500 font-medium">Hệ thống giám sát tín chỉ tự động</p>
                    </div>
                </div>
                <div class="flex items-center gap-4">
                    <div class="hidden md:flex items-center gap-2 px-3 py-1 bg-green-50 text-green-700 rounded-full text-xs font-semibold border border-green-100">
                        <span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span>
                        Connected
                    </div>
                </div>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div class="max-w-3xl mx-auto mb-10">
            <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-1">
                <form onsubmit="handleAddClass(event)" class="flex flex-col sm:flex-row gap-2">
                    <input type="text" id="class-url" class="block w-full pl-5 pr-3 py-3 border-none rounded-xl focus:ring-2 focus:ring-indigo-500 focus:bg-slate-50 text-slate-800 placeholder-slate-400" placeholder="Dán link lớp học DTU vào đây..." autocomplete="off">
                    <button type="submit" class="px-6 py-3 bg-indigo-600 hover:bg-indigo-700 text-white font-semibold rounded-xl shadow-md flex items-center justify-center gap-2">
                        <i class="fa-solid fa-plus"></i><span>Thêm Lớp</span>
                    </button>
                </form>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="bg-gradient-to-br from-indigo-500 to-purple-600 rounded-2xl p-6 text-white shadow-lg">
                <div class="text-indigo-100 text-sm font-medium mb-1">Tổng số lớp</div>
                <div class="text-3xl font-bold" id="stat-total">0</div>
            </div>
            <div class="bg-white rounded-2xl p-6 border border-slate-200 shadow-sm">
                <div class="text-slate-500 text-sm font-medium mb-1">Có slot trống</div>
                <div class="text-3xl font-bold text-green-600" id="stat-available">0</div>
            </div>
            <div class="bg-white rounded-2xl p-6 border border-slate-200 shadow-sm">
                <div class="text-slate-500 text-sm font-medium mb-1">Cập nhật lúc</div>
                <div class="text-3xl font-bold text-slate-700" id="stat-last-check">--:--</div>
            </div>
        </div>

        <div id="class-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
        
        <div id="empty-state" class="hidden text-center py-20">
            <h3 class="text-xl font-bold text-slate-800 mb-2">Chưa có lớp nào</h3>
        </div>
    </main>
</body>
</html>